<html>
    <head>
        <title>AI4Labour</title>
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
        <link rel="icon" type="image/png" href="favicon.png">        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="terminoteca.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonld/1.0.0/jsonld.min.js"></script>        
        <script type="text/javascript" src="terminoteca.js"></script>        
        <style>

            .tablaconcepts
            {
                margin: auto;
                width: 800px;
                table-layout: fixed;
                border-collapse:separate;
                border-spacing:0 20px;
            }

            .tablaconcepts tr
            {
                border-bottom: 300px;
                border-bottom: 300px;


            }
            .tablaconcepts td
            {
                background: #F5F5F5;
                border: 1px solid ;
                border-color: #D6D6D6;
                border-radius: 10px 10px 10px 10px;
                padding: 7px 10px;
                padding-top: 20px;
            }


            .conceptid {
                font-size: 16px;
                /* height: 10px; */
                background: #3077B7;
                border-radius: 5px 5px 5px 5px;
                padding: 7px 10px;
                color: white;
            }
            .language {
                font-weight: bold;
                font-size: large;
            }
            .plantilla {
                color: #808080;
                font-family: "Fira Sans", Arial, sans-serif;
            }
            .contenidos {
                color: #7070C0;
                font-family: "Fira Sans", Arial, sans-serif;
            }
            .preflabel {
                font-weight: bold;
                font-size: large;
            }

            hr{
                margin: 15px;
                border: 1px solid #808080;
            }
            .hrsoft{
                margin: 10px;
                border: 1px solid #DEDEDE;
            }
            #idbulk{
                font-size: small;
            }


        </style>
    </head>
    <body onload="inicio()">


        <!-- No bootstrap. Organization as in https://matthewjamestaylor.com/bottom-footer -->
        <div id="vcontainer">
            <div id="vheader">
                <div w3-include-html="header.html"></div>
                <div style="visibility:hidden; position:absolute; top: 5px; right: 5px; width: 105px; text-align:right;">
                    <a href="/admin/index.html"><img src="/images/admin.png" width="32"></a><br>
                    <span id="spanlanguage"></span>
                </div> 
            </div> 

<!--            <div style="position:absolute;top:0px;left: 0px;">
                <a href="termitupdemo.html"><img src="https://termitup.oeg.fi.upm.es/static/images/termitup_logo_oeg_notermita.svg" width=100px /></a>
                <a href="easySKOS.html"><img src="http://terminoteca.linkeddata.es/images/easySKOS.svg" width=100px /></a>
            </div> -->
            

            <div id="vbody">

                <form class="example" onSubmit="search();" style="margin:auto;max-width:450px; margin-bottom:50px;">
                    <input type="text" placeholder="Write here a task you would like to learn" name="q" >
                    <button type="submit" ><i class="fa fa-search"></i></button>
                </form>

                <table id="idresults" class="tablaconcepts" >

                </table>



            </div>
            <div id="vfooter">
                <div w3-include-html="footer.html"></div>
            </div>
        </div>        

        <script>
            includeHTML();

            function inicio()
            {
                console.log("Welcome!");

                var language = window.navigator.userLanguage || window.navigator.language;
                var elemlan = document.getElementById("spanlanguage");
                elemlan.innerHTML = "Lang:" + language;

                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);
                if (urlParams.has('q'))
                {
                    const cadena = urlParams.get('q');
                    console.log("Searching " + cadena)
                    fsearch(cadena);
                    //        const response = await fetch('/status');
                    //        const estatus = await response.json();    
                    //        document.getElementById("idcompanies").innerHTML = emovies;
                    //        console.log(emovies);
                }
                if (!urlParams.has('conceptid') && urlParams.has('schemeid'))
                {
                    const schemeid = urlParams.get('schemeid');
                    showscheme(schemeid);

                }
                if (urlParams.has('conceptid') && urlParams.has('schemeid'))
                {
                    const schemeid = urlParams.get('schemeid');
                    const conceptid = urlParams.get('conceptid');
                    showconcept(schemeid, conceptid);
                }

            }


            async function showscheme(schemeid)
            {
                console.log("Mostrando esquema " + schemeid);
                const response = await fetch('/scheme/' + schemeid);
                const jscheme = await response.json();
                var celda = createSchemeCard(jscheme)
                var tabla = document.getElementById("idresults");
                var tr = tabla.insertRow(-1);
                var tabCell0 = tr.insertCell(-1);
                tabCell0.style.background = "#E0F0E0";
                tabCell0.innerHTML = celda;

            }
            async function showconcept(schemeid, conceptid)
            {
                console.log("Mostrando " + conceptid + " de " + schemeid);
                const response = await fetch('/scheme/' + schemeid + "/concept/" + conceptid);
                const jconcept = await response.json();
                console.log(jconcept);
                var celda = createCard(jconcept)
                var tabla = document.getElementById("idresults");
                var tr = tabla.insertRow(-1);
                var tabCell0 = tr.insertCell(-1);
                tabCell0.innerHTML = celda;

            }

            //This is invoked when you click the search button
            function fsearch(cadena) {
                console.log("Buscando ahora " + cadena);
                try {
                    var tabla = document.getElementById("idresults");
                    var http = new XMLHttpRequest();
                    var language = window.navigator.userLanguage || window.navigator.language;
                    const qurl = new URL("/api/search/", document.baseURI);
                    qurl.searchParams.append("text", cadena);
                    qurl.searchParams.append("preflang", language);
                    http.open("GET", qurl, true);
                    http.send();
                    const conceptids = new Set();
                    http.onload = function () {
                        var estatus = http.responseText;
                        var jconcepts = JSON.parse(estatus);
                        for (var i = 0; i < jconcepts.length; i++) {
                            var jconcept = jconcepts[i];
                            var id = jconcept["@id"];
                            if (conceptids.has(id))
                                continue;
                            conceptids.add(id);
                            var tr = tabla.insertRow(-1);
                            var tabCell0 = tr.insertCell(-1);
                            var celda = createCard(jconcept);
                            tabCell0.innerHTML = celda;
                        }
                    }
                } catch (e) {
                    console.log(e);
                }
            }

            /**
             * Creates beautiful HTML for a concept
             * */
            function createCard(jconcept)
            {
                //user langauge. eg: es-ES
                var language = window.navigator.userLanguage || window.navigator.language;
                language = language.substring(0, 2);

                var id = jconcept["@id"];
                id = id.substring(id.lastIndexOf('/') + 1);
                var celda = "";

                var scheme = "";
                if (jconcept.inScheme)
                {
                    scheme = jconcept.inScheme;
                    scheme = scheme.substring(scheme.lastIndexOf('/') + 1);
                }


                celda += '<span class="conceptid"><a href="https://terminoteca.linkeddata.es/?schemeid=' + scheme + '&conceptid=' + id + '">' + id + '</a></span>';
                celda += '<span style="float:right;">';
                celda += '<a href="scheme/' + scheme + '/concept/' + id + '?format=ntriples"><img src="images/docrdf.png" width=32px style="margin-top:-10px;"></a>';
                celda += '<a href="scheme/' + scheme + '/concept/' + id + '?format=lemon"><img src="images/doclemon.png" width=32px style="margin-top:-10px;"></a>';
                celda += '<a href="scheme/' + scheme + '/concept/' + id + '"><img src="images/docjson.png" width=32px style="margin-top:-10px;"></a>';
                celda += '</span>';

                celda += "<hr/>"


                //exact/narrower/broader?
                if (jconcept.sameAs)
                {
                    celda += '<span style="float:right;">';
                    for (var narrow in jconcept.sameAs)
                    {
                        const direccion = jconcept.sameAs[narrow];
                        const name = direccion.substring(direccion.lastIndexOf('/') + 1)
                        celda += '<a href="' + direccion + '">' + '<img alt="same as" src="/images/outlink.png" width=20>' + "</a> ";
                    }
                    celda += '</span>';
                }
                if (jconcept.exactMatch)
                {
                    celda += '<p><span class="plantilla">Exact match: </span><span class="contenidos"> ';
                    for (var narrow in jconcept.exactMatch)
                    {
                        const direccion = jconcept.exactMatch[narrow];
                        const name = direccion.substring(direccion.lastIndexOf('/') + 1)
                        celda += '<a href="' + direccion + '">' + name + "</a>, ";
                    }
                    celda = celda.substring(0, celda.length - 2);
                    celda += '</span></p>';
                }
                if (jconcept.narrower)
                {
                    celda += '<p><span class="plantilla">Narrower: </span><span class="contenidos"> ';
                    for (var narrow in jconcept.narrower)
                    {
                        const direccion = jconcept.narrower[narrow];
                        const name = direccion.substring(direccion.lastIndexOf('/') + 1);
                        var enlace = '<a href="https://terminoteca.linkeddata.es/?schemeid=' + scheme + '&conceptid=' + name + '">' + name + '</a>, ';
                        celda += enlace;
                        console.log("Enlace: " + enlace);
//                     celda += '<a href="' + direccion + '">' + name + "</a>, ";
                    }
                    celda = celda.substring(0, celda.length - 2);
                    celda += '</span></p>';
                }
                if (jconcept.broader)
                {
                    celda += '<p><span class="plantilla">Broader: </span><span class="contenidos"> ';
                    for (var narrow in jconcept.broader)
                    {
                        const direccion = jconcept.broader[narrow];
                        const name = direccion.substring(direccion.lastIndexOf('/') + 1)
//                        celda += '<a href="' + direccion + '">' + name + "</a>, ";
                        celda += '<a href="https://terminoteca.linkeddata.es/?schemeid=' + scheme + '&conceptid=' + name + '">' + name + '</a>, ';

                    }
                    celda = celda.substring(0, celda.length - 2);
                    celda += '</span></p>';
                }
                celda += '<hr class="hrsoft">\n';


                Object.keys(jconcept.prefLabel).forEach(function (lan) {
                    console.log(lan);
                    if (true)//(lan === language)   //si solo queremos un único idioma.
                    {
                        var pref = jconcept.prefLabel[lan];
                        celda += lan + ' <span class="preflabel">' + pref + '</span>';

                        if (jconcept.altLabel && jconcept.altLabel[lan])
                        {
                            celda += '<p><span class="plantilla">Alternative: </span><span class="contenidos"> '
                            for (var alternativo in jconcept.altLabel[lan])
                                celda += jconcept.altLabel[lan][alternativo] + ", ";
                            celda = celda.substring(0, celda.length - 2);
                            celda += '</span></p>';
                        }
                        if (jconcept.definition && jconcept.definition[lan])
                        {
                            celda += '<p><span class="plantilla">Definition: </span><span class="contenidos"> '
                            for (var alternativo in jconcept.definition[lan])
                                celda += jconcept.definition[lan][alternativo] + ", ";
                            celda = celda.substring(0, celda.length - 2);
                            celda += '</span></p>';
                        }
                        if (jconcept.note && jconcept.note[lan])
                        {
                            celda += '<p><span class="plantilla">Note: </span><span class="contenidos"> '
                            for (var alternativo in jconcept.note[lan])
                                celda += jconcept.note[lan][alternativo] + ", ";
                            celda = celda.substring(0, celda.length - 2);
                            celda += '</span></p>';
                        }
                        celda += '<hr class="hrsoft">\n';
                    }

                });

                celda += '<div style="float:right;font-size:small;">In scheme: <a href="/?schemeid=' + scheme + '">' + scheme + '</></div>';

                return celda;
            }

            /**
             * Creates beautiful HTML for a SKOS Concept Scheme
             * */
            function createSchemeCard(jscheme)
            {
                //user langauge. eg: es-ES
                var language = window.navigator.userLanguage || window.navigator.language;
                language = language.substring(0, 2);

                var id = jscheme["@id"];
                id = id.substring(id.lastIndexOf('/') + 1);

                console.log(jscheme);
                var celda = "";

                celda += '<span class="conceptid">' + id + '</span>';
                celda += '<span style="float:right;">';
//                    celda+='<a href="scheme/'+scheme+'/concept/'+id+'?format=ntriples"><img src="images/docrdf.png" width=32px style="margin-top:-10px;"></a>';
//                    celda+='<a href="scheme/'+scheme+'/concept/'+id+'?format=lemon"><img src="images/doclemon.png" width=32px style="margin-top:-10px;"></a>';
                celda += '<a href="scheme/' + id + '"><img src="images/docjson.png" width=32px style="margin-top:-10px;"></a>';
                celda += '</span>';
                celda += "<hr/>"

                //exact/narrower/broader?
                if (jscheme.prefLabel)
                {
                    if (jscheme.prefLabel[language])
                    {
                        var txt = jscheme.prefLabel[language];
                        celda += '<span class="preflabel">' + txt + '</span>';
                    } else
                    {
                        Object.keys(jscheme.prefLabel).forEach(function (lan) {
                            var pref = jscheme.prefLabel[lan];
                            celda += lan + ' <span class="preflabel">' + pref + '</span> ';
                        });
                    }
                    celda += '<hr class="hrsoft">\n';
                }
                if (jscheme.comment)
                {
                    celda += '<span class="plantilla">Comment</span><span class="contenidos"> ';
                    celda += escapeHtml(jscheme.comment);
                    celda += '</span>';
                }

                if (jscheme.creator)
                {
                    celda += '<p><span class="plantilla">Creator: </span><span class="contenidos"> ';
                    if (typeof jscheme.creator === 'string' || jscheme.creator instanceof String)
                    {
                        celda += jscheme.creator;
                    } else if (Array.isArray(jscheme.creator))
                    {
                        for (var alternativo in jscheme.creator)
                            celda += jscheme.creator[alternativo] + ", ";
                        celda = celda.substring(0, celda.length - 2);
                    } else if (typeof jscheme.creator === 'object')
                    {
                        var keys = Object.keys(jscheme.creator);
                        celda += jscheme.creator[keys[0]];
                    }
                    celda += '</span></p>';
                }

                if (jscheme.numElements)
                {
                    celda += '<span class="plantilla">Concepts: </span><span class="contenidos"> ';
                    celda += jscheme.numElements;
                    celda += '</span>';
                }
                if (jscheme.source)
                {
                    celda += '<span class="plantilla">Source: </span><span class="contenidos"> ';
                    celda += jscheme.source;
                    celda += '</span>';
                }

//                    https://terminoteca.linkeddata.es/?schemeid=fosat&conceptid=6310                    

                celda += '<hr class="hrsoft">\n';
                celda += '<div id="idbulk"></div>';

                fetch('/scheme/' + id + "/bulk").then(response => response.json()).then(response => bulkready(response, id));

                return celda;
            }

            function bulkready(jbulk, schemeid)
            {
                var language = window.navigator.userLanguage || window.navigator.language;
                language = language.substring(0, 2);

                jbulk = jbulk.hasTopConcept;

                var divbulk = document.getElementById("idbulk");
                var str = "";
                for (var i in jbulk)
                {
                    var concept = jbulk[i];
                    var id = concept["@id"];
                    id = id.substring(id.lastIndexOf('/') + 1);
                    var txt = id;
                    if (concept.prefLabel && concept.prefLabel[language])
                        txt = concept.prefLabel[language];
                    str += '(<a style="text-decoration:none;" href="/?schemeid=' + schemeid + '&conceptid=' + id + '">' + txt + "</a>) ";
                }
                divbulk.innerHTML = str;
            }

            function festatus() {
                console.log("Checking status");
                try {
                    var http = new XMLHttpRequest();
                    http.open("GET", '/api/status', true); //true
                    http.send();
                    http.onload = function () {
                        var estatus = http.responseText;
                        console.log(estatus);
                    }
                } catch (e)
                {

                }
            }
            function escapeHtml(unsafe) {
                return unsafe
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;");
            }
        </script>        
    </body>
</html>